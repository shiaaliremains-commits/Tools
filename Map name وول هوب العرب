-- [[ MafiaAlJalab Universal Hitbox System V11.0 - (ESP Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… + Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±Ù‚) ]]
-- Hitbox Ù…Ø­Ø³Ù‘Ù† Ùˆ ESP (Ø¨ÙˆÙƒØ³ ÙˆÙ‡Ø§ÙŠÙ„Ø§ÙŠØª) ÙÙ‚Ø· Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡.
-- [[ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Gemini - Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±Ù‚ + ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ…Ø± ]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService") 
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- â­ï¸

-- â­ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚ (Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§) â­ï¸
local TeamsFolder = ReplicatedStorage:WaitForChild("Teams")
local TeamT = TeamsFolder:WaitForChild("T")
local TeamCT = TeamsFolder:WaitForChild("CT")

-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Hitbox Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
local HEAD_SIZE = Vector3.new(5, 5, 5)
local HEAD_COLOR = Color3.fromRGB(255, 100, 100) 
local HEAD_TRANSPARENCY = 0.5            

-- ğŸ”´ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ØµØ§Ø± Ù‡Ù†Ø§: ØªÙ… ØªÙƒØ¨ÙŠØ± Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù€ Torso ğŸ”´ğŸ”´
local TORSO_SIZE = Vector3.new(6, 6, 4) -- ÙƒØ§Ù†Øª (4, 5, 2)
local TORSO_COLOR = Color3.fromRGB(100, 100, 255) 
local TORSO_TRANSPARENCY = 0.4           

-- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
local HitboxTargetPart = "Head" 
local KeybindCooldown = 0.5 
local LastToggleTime = 0 

-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ESP
local ESPColorVisible = Color3.fromRGB(100, 255, 150) 
local ESPColorHidden = Color3.fromRGB(255, 80, 80)    

-- Ø§Ù„ÙƒØ§Ø´Ø§Øª
local ESPCache = {} 
local ESPFolder = nil
local ModifiedPartsCache = {} 
local ESPUPDATEINTERVAL = 0.1

-- -----------------------------
-- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
-- -----------------------------
local function getRootPart(character)
    if not character then return nil end
    return character:FindFirstChild("HumanoidRootPart")
end

local function getHumanoid(character)
    if not character then return nil end
    return character:FindFirstChildOfClass("Humanoid")
end

-- â­ï¸ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ¯ ÙØ±ÙŠÙ‚ Ø§Ù„Ù„Ø§Ø¹Ø¨ â­ï¸
-- Ù‡Ø§ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙØ­Øµ Ø¥Ø°Ø§ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ ÙÙˆÙ„Ø¯Ø±Ø§Øª Ø§Ù„ÙØ±Ù‚
local function getPlayerTeam(player)
    if not player then return "None" end
    
    if TeamT:FindFirstChild(player.Name) then
        return "T"
    end
    
    if TeamCT:FindFirstChild(player.Name) then
        return "CT"
    end
    
    return "None"
end

-- -----------------------------
-- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡Ø§)
-- -----------------------------
local function showNotification(text)
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    if playerGui:FindFirstChild("HitboxNotificationGui") then 
        playerGui:FindFirstChild("HitboxNotificationGui"):Destroy() 
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "HitboxNotificationGui"
    screenGui.Parent = playerGui
    screenGui.DisplayOrder = 100 
    screenGui.ResetOnSpawn = false
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0.3, 0, 0, 40) 
    frame.Position = UDim2.new(0, 10, 0, 50) 
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30) 
    frame.BackgroundTransparency = 0.5 
    frame.BorderSizePixel = 0
    frame.Parent = screenGui

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 16
    textLabel.Parent = frame
    
    game:GetService("Debris"):AddItem(screenGui, 2.5)
end

-- -----------------------------
-- Ø¯ÙˆØ§Ù„ Hitbox 
-- -----------------------------
local function getPartsToModify(character, mode)
    if mode == "Head" then
        return {character:FindFirstChild("Head")}
    elseif mode == "Torso" then
        return {character:FindFirstChild("UpperTorso"), character:FindFirstChild("LowerTorso")}
    end
    return {}
end

local function applyHitboxModifications(player, mode)
    if player == LocalPlayer then return end
    
    local character = player.Character
    if not character then return end
    
    if ModifiedPartsCache[player] then
        for _, part in ipairs(ModifiedPartsCache[player]) do
            local tag = part:FindFirstChild("UniversalHitbox")
            if tag then
                part.Size = part.Name == "Head" and Vector3.new(2, 1, 1) or Vector3.new(2, 2, 1)
                part.BrickColor = BrickColor.new("Bright yellow") 
                part.Transparency = 0
                part.Material = Enum.Material.Plastic
                part.CanCollide = true
                tag:Destroy()
            end
        end
        ModifiedPartsCache[player] = nil
    end

    local partsToModify = getPartsToModify(character, mode)
    ModifiedPartsCache[player] = {}

    for _, part in ipairs(partsToModify) do
        if part and part:IsA("BasePart") then
            
            local size, color, transparency
            if mode == "Head" then
                size = HEAD_SIZE
                color = HEAD_COLOR
                transparency = HEAD_TRANSPARENCY
            elseif mode == "Torso" then
                size = TORSO_SIZE
                color = TORSO_COLOR
                transparency = TORSO_TRANSPARENCY
            end
            
            part.Size = size
            part.BrickColor = BrickColor.new(color)
            part.Transparency = transparency
            part.Material = Enum.Material.Neon 
            part.CanCollide = true 
            
            local tag = Instance.new("StringValue")
            tag.Name = "UniversalHitbox"
            tag.Value = mode 
            tag.Parent = part
            
            table.insert(ModifiedPartsCache[player], part)
        end
    end
end

local function restorePlayerParts(player)
    -- Ù‡Ø§ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ±Ø¬Ø¹ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡Ø§
    if ModifiedPartsCache[player] then
        for _, part in ipairs(ModifiedPartsCache[player]) do
            if part and part.Parent then
                part.Size = part.Name == "Head" and Vector3.new(2, 1, 1) or Vector3.new(2, 2, 1)
                part.BrickColor = BrickColor.new("Bright yellow") 
                part.Transparency = 0
                part.Material = Enum.Material.Plastic
                part.CanCollide = true
                
                local tag = part:FindFirstChild("UniversalHitbox")
                if tag then
                    tag:Destroy()
                end
            end
        end
        ModifiedPartsCache[player] = nil
    end
end

local function refreshAllHitboxes(mode)
    HitboxTargetPart = mode
    
    -- â­ï¸ ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù€ Hitbox Ù‡Ø³Ù‡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© refreshESP
    -- Ù„Ø°Ù„Ùƒ Ù†Ø­Ø°Ù Ø§Ù„Ù„ÙˆØ¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ†Ø®Ù„ÙŠ refreshESP ØªØ³ÙˆÙŠ Ø§Ù„Ø´ØºÙ„
    
    -- ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    updateToggleButton()
    
    local message
    if mode == "Head" then
        message = "ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Hitbox\n-Head-"
    elseif mode == "Torso" then
        message = "ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Hitbox\n-Torso-"
    end
    showNotification(message)
    print("âœ¨ Hitbox Mode Switched To: " .. mode .. " (Keybind: H)")
end

-- -----------------------------
-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
-- -----------------------------
local function toggleHitboxMode()
    local currentTime = tick()
    
    if currentTime - LastToggleTime < KeybindCooldown then
        return 
    end
    
    if HitboxTargetPart == "Head" then
        refreshAllHitboxes("Torso") 
    else
        refreshAllHitboxes("Head")
    end
    
    LastToggleTime = currentTime
end

-- -----------------------------
-- Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
-- -----------------------------
local toggleButton = nil

local function createToggleButton()
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    
    if playerGui:FindFirstChild("HitboxToggleGui") then 
        playerGui:FindFirstChild("HitboxToggleGui"):Destroy() 
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "HitboxToggleGui"
    screenGui.Parent = playerGui
    screenGui.DisplayOrder = 99
    screenGui.ResetOnSpawn = false 
    
    toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 80, 0, 30)
    toggleButton.Position = UDim2.new(0, 10, 0, 100) 
    toggleButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    toggleButton.BackgroundTransparency = 0.3
    toggleButton.BorderSizePixel = 1
    toggleButton.BorderColor3 = Color3.fromRGB(100, 100, 100)
    toggleButton.Text = ""
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.TextSize = 12
    toggleButton.ZIndex = 2
    toggleButton.Parent = screenGui
    
    local buttonShadow = Instance.new("Frame")
    buttonShadow.Size = UDim2.new(1, 4, 1, 4)
    buttonShadow.Position = UDim2.new(0, -2, 0, -2)
    buttonShadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    buttonShadow.BackgroundTransparency = 0.7
    buttonShadow.BorderSizePixel = 0
    buttonShadow.ZIndex = 1
    buttonShadow.Parent = toggleButton
    
    local buttonText = Instance.new("TextLabel")
    buttonText.Size = UDim2.new(1, 0, 1, 0)
    buttonText.BackgroundTransparency = 1
    buttonText.Text = "Hitbox - Head"
    buttonText.TextColor3 = Color3.fromRGB(255, 100, 100) 
    buttonText.Font = Enum.Font.GothamBold
    buttonText.TextSize = 12
    buttonText.ZIndex = 3
    buttonText.Parent = toggleButton
    
    toggleButton.MouseButton1Click:Connect(function()
        toggleHitboxMode()
    end)
    
    toggleButton.MouseEnter:Connect(function()
        toggleButton.BackgroundTransparency = 0.1
    end)
    toggleButton.MouseLeave:Connect(function()
        toggleButton.BackgroundTransparency = 0.3
    end)
end

-- Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù†Øµ ÙˆÙ„ÙˆÙ† Ø§Ù„Ø²Ø±
local function updateToggleButton()
    if toggleButton then
        local textLabel = toggleButton:FindFirstChildOfClass("TextLabel")
        if textLabel then
            
            if HitboxTargetPart == "Head" then
                textLabel.Text = "Hitbox - Head"
                textLabel.TextColor3 = Color3.fromRGB(255, 100, 100) -- Ø£Ø­Ù…Ø±
            else
                textLabel.Text = "Hitbox - Torso"
                textLabel.TextColor3 = Color3.fromRGB(100, 100, 255) -- Ø£Ø²Ø±Ù‚
            end
        end
    end
end

-- -----------------------------
-- Ø±Ø¨Ø· Ø§Ù„Ù…ÙØªØ§Ø­
-- -----------------------------
UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
    if input.KeyCode == Enum.KeyCode.H and not gameProcessedEvent and not UserInputService:GetFocusedTextBox() then
        toggleHitboxMode()
    end
end)

-- -----------------------------
-- Ø¯ÙˆØ§Ù„ ESP Ùˆ Hit Detection
-- -----------------------------
local function setupHitDetection()
    Workspace.DescendantAdded:Connect(function(obj)
        if obj:IsA("Part") and obj.Name == "Bullet" then
            obj.Touched:Connect(function(hit)
                if hit and hit.Parent and hit.Parent:FindFirstChild("Humanoid") then
                    local hitboxTag = hit:FindFirstChild("UniversalHitbox")
                    
                    if hitboxTag then
                        local hum = hit.Parent:FindFirstChild("Humanoid")
                        local player = Players:GetPlayerFromCharacter(hit.Parent)
                        
                        if player and player ~= LocalPlayer then
                            hum:TakeDamage(100)
                        end
                    end
                end
            end)
        end
    end)
end

local function createESPFolder() 
    if not ESPFolder or not ESPFolder.Parent then 
        ESPFolder = Instance.new("Folder")
        ESPFolder.Name = "MafiaAlJalabUniversalHitbox_V11"
        ESPFolder.Parent = Camera
    end 
end

local function isPlayerVisible(player) 
    local localChar = LocalPlayer.Character
    local targetChar = player.Character
    local localRoot = getRootPart(localChar)
    local targetRoot = getRootPart(targetChar)
    if not localRoot or not targetRoot then return false end
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {localChar, targetChar}
    
    local direction = targetRoot.Position - localRoot.Position
    local raycastResult = Workspace:Raycast(localRoot.Position, direction, raycastParams)
    
    return not raycastResult
end

local function destroyESPOne(player) 
    -- Ù‡Ø§ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ†Ø¸Ù Ø§Ù„Ù€ ESP Ù…Ù† Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯
    if ESPCache[player] then 
        for _, obj in pairs(ESPCache[player]) do 
            if obj and obj.Parent then 
                obj:Destroy() 
            end 
        end
        ESPCache[player] = nil 
    end 
end

local function createBoxESP(player, espColor) 
    local character = player.Character
    local rootPart = getRootPart(character)
    if not rootPart then return nil end
    
    local box = Instance.new("BoxHandleAdornment")
    box.Adornee = rootPart
    box.AlwaysOnTop = true
    box.Size = Vector3.new(2.5, 5, 1.5)
    box.Color3 = espColor
    box.Transparency = 0.7
    box.ZIndex = 3
    box.Parent = ESPFolder
    
    local highlight = Instance.new("Highlight")
    highlight.Adornee = character
    highlight.FillColor = espColor
    highlight.FillTransparency = 0.8
    highlight.OutlineColor = espColor
    highlight.OutlineTransparency = 0.5
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = ESPFolder
    
    return {Box = box, Highlight = highlight}
end

local function updateESP(espObjects, player) 
    local isVisible = isPlayerVisible(player)
    local espColor = isVisible and ESPColorVisible or ESPColorHidden
    
    if espObjects.Box and espObjects.Box.Parent then espObjects.Box.Color3 = espColor end
    if espObjects.Highlight and espObjects.Highlight.Parent then 
        espObjects.Highlight.FillColor = espColor
        espObjects.Highlight.OutlineColor = espColor 
    end
    
    local newRoot = getRootPart(player.Character)
    if newRoot then
         if espObjects.Box.Adornee ~= newRoot then espObjects.Box.Adornee = newRoot end
    end
end

-- -----------------------------------------------------------------
-- â­ï¸â­ï¸ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ ESP (Ù…Ø¹Ø¯Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ØªØ¯Ø¹Ù… Ø§Ù„ÙØ±Ù‚ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´) â­ï¸â­ï¸
-- -----------------------------------------------------------------
local function refreshESP() 
    createESPFolder()
    
    -- 1. ØªØ­Ø¯ÙŠØ¯ ÙØ±ÙŠÙ‚ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ
    local localPlayerTeam = getPlayerTeam(LocalPlayer)
    
    -- 2. (ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´) - Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØ¹ÙˆØ¯ÙˆØ§ Ø£Ø¹Ø¯Ø§Ø¡
    -- Ù‡Ø§ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ù…Ø§ ÙŠØµÙŠØ± Lag
    local playersToRemove = {}
    for player, cachedObjects in pairs(ESPCache) do 
        local humanoid = getHumanoid(player.Character)
        local targetPlayerTeam = getPlayerTeam(player)
        
        -- Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ¹ØªØ¨Ø± Ø¹Ø¯Ùˆ ÙÙ‚Ø· Ø¥Ø°Ø§:
        -- 1. Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
        -- 2. Ø¹Ù†Ø¯Ù‡ Humanoid ÙˆØµØ­ØªÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† 0
        -- 3. Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù†Ø¯Ù‡ ÙØ±ÙŠÙ‚ ("None" Ù…Ø§ ÙŠØ¹ØªØ¨Ø± ÙØ±ÙŠÙ‚)
        -- 4. Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¹Ù†Ø¯Ù‡ ÙØ±ÙŠÙ‚
        -- 5. ÙØ±ÙŠÙ‚Ù‡Ù… Ù…Ø®ØªÙ„Ù
        local isStillEnemy = player.Parent and player:IsA("Player") and humanoid and humanoid.Health > 0 and 
                           localPlayerTeam ~= "None" and targetPlayerTeam ~= "None" and 
                           localPlayerTeam ~= targetPlayerTeam
        
        if not isStillEnemy then 
            -- Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ø¹Ø¯Ùˆ (Ù…Ø§ØªØŒ Ø·Ù„Ø¹ØŒ ØºÙŠØ± ÙØ±ÙŠÙ‚Ù‡ØŒ Ø£Ùˆ Ø¥Ø­Ù†Ø§ ØµØ±Ù†Ø§ Ø¨Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚)
            table.insert(playersToRemove, player)
        end 
    end
    
    -- 3. (ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´) - Ø­Ø°Ù Ø§Ù„Ù€ ESP ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
    -- Ù‡Ø§ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡ÙŠ Ø§Ù„Ù„ÙŠ ØªÙ…Ù†Ø¹ Ø§Ù„Ù€ Lag Ø§Ù„Ù„ÙŠ Ø°ÙƒØ±ØªÙ‡
    for _, player in ipairs(playersToRemove) do
        destroyESPOne(player)
        restorePlayerParts(player) 
    end
    
    -- 4. (Ø§Ù„ØªØ­Ø¯ÙŠØ«) - Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
    for _, player in ipairs(Players:GetPlayers()) do 
        if player == LocalPlayer then continue end -- ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ
        
        local humanoid = getHumanoid(player.Character)
        local targetPlayerTeam = getPlayerTeam(player)
        
        -- ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ø¯Ùˆ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙˆÙ‚)
        local isEnemy = player.Character and humanoid and humanoid.Health > 0 and
                        localPlayerTeam ~= "None" and targetPlayerTeam ~= "None" and 
                        localPlayerTeam ~= targetPlayerTeam
        
        if isEnemy then 
            -- 5. (ØªØ·Ø¨ÙŠÙ‚) - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯ÙˆØŒ Ø·Ø¨Ù‚ Ø§Ù„Ù€ Hitbox ÙˆØ§Ù„Ù€ ESP
            applyHitboxModifications(player, HitboxTargetPart)
            
            if not ESPCache[player] then 
                -- Ø¥Ù†Ø´Ø§Ø¡ ESP Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡
                local initialColor = ESPColorHidden
                local espObjects = createBoxESP(player, initialColor)
                if espObjects then 
                    ESPCache[player] = espObjects 
                end
            else 
                -- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ ESP Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                updateESP(ESPCache[player], player) 
            end 
        else 
            -- 6. (ØªØ¬Ø§Ù‡Ù„) - Ø¥Ø°Ø§ ÙƒØ§Ù† (Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ØŒ Ù…ÙŠØªØŒ Ù…Ø§Ø¹Ù†Ø¯Ù‡ ÙØ±ÙŠÙ‚)
            -- Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø¬Ø§Ø¹ Ø£Ø¬Ø²Ø§Ø¡Ù‡ Ù„ÙˆØ¶Ø¹Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ (Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡ ESP)
            restorePlayerParts(player)
            -- (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡ ESPØŒ ÙÙ€ "playersToRemove" ÙÙˆÙƒ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø­Ø°ÙØªÙ‡)
        end 
    end 
end


-- -----------------------------
-- Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
-- -----------------------------
local lastESPUpdate = 0

local function initialize()
    setupHitDetection()
    createToggleButton()
    
    RunService.Heartbeat:Connect(function() 
        if tick() - lastESPUpdate > ESPUPDATEINTERVAL then 
            refreshESP()
            lastESPUpdate = tick() 
        end 
    end)

    Players.PlayerRemoving:Connect(function(player)
        -- ØªÙ†Ø¸ÙŠÙ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù†Ø¯ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù„Ø§Ø¹Ø¨
        destroyESPOne(player)
        restorePlayerParts(player)
        
        if player == LocalPlayer and ESPFolder then 
            ESPFolder:Destroy() 
            for otherPlayer, _ in pairs(ModifiedPartsCache) do
                restorePlayerParts(otherPlayer)
            end
        end 
    end)

    -- â­ï¸ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£ÙˆÙ„ÙŠ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    refreshESP()
    -- Ø¶Ø¨Ø· Ø§Ù„Ø²Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    refreshAllHitboxes("Head") 

    print("[MafiaAlJalab Universal Hitbox V11.0 - Team-Based Mod] Activated!")
    print("âœ¨ Initial Hitbox Mode: Head (Toggle with H)")
    print("ğŸ–±ï¸ Toggle Button: Created")
    print("ğŸ“Š ESP System: Active (No Names, Team-Based, Auto-Cleaning)")
    print("ğŸ”« Hit Detection: Active")
end

task.wait(1)
initialize()
